name: CD - Deploy to Staging

on:
  workflow_run:
    workflows: ["Frontend CI - Build & Push Image"]
    types:
      - completed

jobs:
  deploy_backend:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'testing' }}
    uses: ./.github/workflows/backend_cd.yml
    with:
      aks_cluster_name: ${{ vars.AKS_CLUSTER_NAME }}
      aks_resource_group: ${{ vars.AKS_RESOURCE_GROUP }}
    secrets: inherit

  deploy_frontend:
    needs: deploy_backend
    uses: ./.github/workflows/frontend_cd.yml
    secrets: inherit

  acceptance_tests:
    needs: deploy_frontend
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Set AKS context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ vars.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ vars.AKS_CLUSTER_NAME }}
      - name: Get Frontend IP
        id: ip
        run: |
          for i in {1..60}; do
            EP=$(kubectl get svc frontend -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
            if [ -n "$EP" ]; then
              echo "FRONTEND=http://$EP" >> $GITHUB_ENV
              exit 0
            fi
            echo "Waiting for frontend LB IP... ($i/60)"
            sleep 5
          done
          echo "Timeout waiting for frontend IP" >&2
          exit 1

      - name: Ping proxied APIs via frontend
        run: |
          set -e
          curl -fsS "$FRONTEND/api/products/"   | head -c 200
          curl -fsS "$FRONTEND/api/orders/"     | head -c 200
          curl -fsS "$FRONTEND/api/customers/"  | head -c 200
